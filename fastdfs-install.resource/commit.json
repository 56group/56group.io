{"compress":true,"commitItems":[["60c4fc02-ee84-422c-aa00-2cf1f0bffe76",1541493585809,"---\ntitle:  FasfDFS暗黄\ndate: 2018-11-04 15:18:00\ntags: [FastDFS, 安装]\ncategories:  Linux\n---\n\n### FastDFS安装\n\n##### 环境准备\n\n```\nshell> yum update -y\nshell> yum upgrade -y\nshell> yum install gcc wget -y\n```\n##### 安装\n\n```\nshell> wget https://github.com/happyfish100/libfastcommon/archive/V1.0.39.tar.gz\nshell> tar zxvf V1.0.39.tar.gz\nshell> cd libfastcommon-1.0.39/\nshell> .make.sh\nshell> ./make.sh install\nshell> ln -s /usr/lib64/libfastcommon.so /usr/lib/libfastcommon.so\nshell> ln -s /usr/lib64/libfastcommon.so /usr/local/lib/libfastcommon.so\nshell> cd ..\nshell> wget https://github.com/happyfish100/fastdfs/archive/V5.11.tar.gz\nshell> tar zxvf V5.11.tar.gz\nshell> cd fastdfs-5.11/\nshell> ./make.sh\nshell> ./make.sh install\nshell> ls /etc/init.d # 目录下包含fdfs_trackerd,fdfs_storaged启动项\nshell> ls ls /etc/fdfs/ # 目录包含client.conf.sample  storage.conf.sample  storage_ids.conf.sample  tracker.conf.sample\nshell> ls /usr/bin/ | grep fdfs\n#fdfs_appender_test\n#fdfs_appender_test1\n#fdfs_append_file\n#fdfs_crc32\n#fdfs_delete_file\n#fdfs_download_file\n#fdfs_file_info\n#fdfs_monitor\n#fdfs_storaged\n#fdfs_test\n#fdfs_test1\n#fdfs_trackerd\n#fdfs_upload_appender\n#fdfs_upload_file\n#stop.sh\n#restart.sh\nshell> ln -s /usr/bin/fdfs_trackerd /usr/local/bin/fdfs_trackerd\nshell> ln -s /usr/bin/fdfs_storaged /usr/local/bin/fdfs_storaged\nshell> ln -s /usr/bin/stop.sh /usr/local/bin/stop.sh\nshell> ln -s /usr/bin/restart.sh /usr/local/bin/restart.sh\nshell> cd /etc/fdfs/\nshell> mv tracker.conf.sample tracker.conf\nshell> vi tracker.conf # tracker.conf\nshell> mkdir -p /var/fastdfs/tracker\nshell> service iptables stop # 或者配置防火墙22122\nshell> service fdfs_trackerd start\nshell> ls /var/fastdfs/tracker/ # 第一次启动成功存在data和logs两个目录\nshell> netstat -npl | grep fdfs # 存在22122端口服务\nshell> service fdfs_trackerd stop\nshell> chkconfig fdfs_trackerd on\nshell> cd /etc/fdfs\nshell> cp storage.conf.sample storage.conf\nshell> vi storage.conf\nshell> mkdir /var/fastdfs/file\nshell> mkdir /var/fastdfs/storage\nshell> service iptales stop # 或者防火墙配置23000\nshell> service fdfs_trackerd start\nshell> service fdfs_storaged start\nshell> netstat -npl | grep fdfs # 22122和23000端口\nshell> chkconfig fdfs_storaged on\n# 查看storage和tracker是否通信\nshell> /usr/bin/fdfs_monitor /etc/fdfs/storage.conf # active\n# 查看文件存储目录\nshell> ls /var/fastdfs/file/data/\nshell> cd /etc/fdfs\nshell> cp client.conf.sample client.conf\nshell> vi client.conf\nshell> mkdir /var/fastdfs/client\n# 测试文件上传\nshell> /usr/bin/fdfs_upload_file /etc/fdfs/client.conf /root/hello.jpg \n# group1/M00/00/00/rBF7wlve7MWAYkBMAAFyMfWGgG0950.jpg # 组/磁盘/目录/目录/文件名\nshell> ls /var/fastdfs/file/data/00/00/\n# rBF7wlve7MWAYkBMAAFyMfWGgG0950.jpg\n```\n##### 安装nginx\n\n```\nshell> cd\nshell> yum install gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel -y\nshell> wget http://nginx.org/download/nginx-1.15.5.tar.gz\nshell> tar zxvf nginx-1.15.5.tar.gz\nshell> cd nginx-1.15.5\nshell> ./configure --prefix=/usr/local/nginx\nshell> make && make install\nshell> cd /usr/local/nginx/\nshell> sbin/nginx # 启动\nshell> vi /etc/rc.local # 添加一行/usr/local/nginx/sbin/nginx\nshell> chmod 755 /etc/rc.local\n# 查看模块\nshell> /usr/local/nginx/sbin/nginx -V # 确定是否有fdfs模块\nshell> service iptables stop # 或者设置80防火墙\nshell> vi /usr/local/nginx/conf/nginx.conf\n# 添加如下信息\n#location /file {\n#\talias /var/fastdfs/file/data;\n#}\nshell> /usr/local/nginx/sbin/nginx -s reload\n# 访问http://IP/file/00/00/rBF7wlve7MWAYkBMAAFyMfWGgG0950.jpg\n```\n##### 安装FastDFS的Nginx模块\n\n```\nshell> cd\nshell> wget https://github.com/happyfish100/fastdfs-nginx-module/archive/V1.20.tar.gz\nshell> tar zxvf V1.20.tar.gz\nshell> /usr/local/nginx/sbin/nginx -s stop\nshell> cd nginx-1.15.5\nshell> ln -s /usr/lib64/libfdfsclient.so /usr/local/lib/libfdfsclient.so\nshell> ln -s /usr/lib64/libfdfsclient.so /usr/lib/libfdfsclient.so\nshell> ln -s /usr/include/fastcommon /usr/local/include/fastcommon\nshell> ln -s /usr/include/fastdfs /usr/local/include/fastdfs\nshell> vi ../fastdfs-nginx-module-1.20/src/config # 更改如下项\n# CORE_INCS=\"$CORE_INCS /usr/local/include/fastdfs /usr/local/include/fastcommon\"\n# CORE_LIBS=\"$CORE_LIBS -L /usr/lib -lfastcommon -lfdfsclient\"\nshell> cp /usr/local/include/fastcommon/* /usr/local/include/fastdfs/\nshell> cp /usr/local/include/fastcommon/* /usr/local/include/fastdfs/\nshell> ./configure --prefix=/usr/local/nginx --add-module=../fastdfs-nginx-module-1.20/src\nshell> make && make install\nshell> /usr/local/nginx/sbin/nginx -V # 查看包含fastdfs模块\nshell> cd ~/fastdfs-nginx-module-1.20/src/\nshell> cp mod_fastdfs.conf /etc/fdfs/\nshell> vi /etc/fdfs/mod_fastdfs.conf\nshell> cd ~/fastdfs-5.11/conf/\nshell> cp anti-steal.jpg http.conf mime.types /etc/fdfs/\nshell> cd /usr/local/nginx\nshell> vi conf/nginx.conf\nshell> /usr/local/nginx/sbin/nginx # 启动\n# 访问http://39.105.88.191/M00/00/00/rBF7wlve7MWAYkBMAAFyMfWGgG0950.jpg\n```\n##### Nginx权限配置\n\n```\n# if use token to anti-steal\n# default value is false (0)\nhttp.anti_steal.check_token=true\n\n# token TTL (time to live), seconds\n# default value is 600\nhttp.anti_steal.token_ttl=1800\n\n# secret key to generate anti-steal token\n# this parameter must be set when http.anti_steal.check_token set to true\n# the length of the secret key should not exceed 128 bytes\nhttp.anti_steal.secret_key=FastDFS1234567890\n\n# return the content of the file when check token fail\n# default value is empty (no file sepecified)\nhttp.anti_steal.token_check_fail=/etc/fdfs/anti-steal.jpg # 可以更改为自定义图片\n```\n##### token代码\n\n```\npackage example.client;\n\nimport org.csource.common.MyException;\nimport org.csource.fastdfs.ProtoCommon;\nimport org.csource.fastdfs.StorageClient1;\n\nimport java.io.UnsupportedEncodingException;\nimport java.security.NoSuchAlgorithmException;\nimport java.time.Instant;\n\npublic class NginxAccessTokenUtil {\n\n    public static String createToken(String filePath, String secretKey) {\n        int ts = (int) Instant.now().getEpochSecond();\n        String token = null;\n\n        try {\n            token = ProtoCommon.getToken(getFilename(filePath), ts, secretKey);\n        } catch (UnsupportedEncodingException e) {\n            e.printStackTrace();\n        } catch (NoSuchAlgorithmException e) {\n            e.printStackTrace();\n        } catch (MyException e) {\n            e.printStackTrace();\n        }\n\n        StringBuilder builder = new StringBuilder();\n        builder.append(\"?token=\").append(token);\n        builder.append(\"&ts=\").append(ts);\n\n        return builder.toString();\n    }\n\n    public static String getFilename(String fileId){\n        String[] results = new String[2];\n        StorageClient1.split_file_id(fileId, results);\n\n        return results[1];\n    }\n}\n\n# create token为?token=544c170e756fad7887c4fa9d21908d01&ts=1541409463,直接添加到访问URL后面\n# 访问的地址更改为 http://IP/group1/M00/00/00/rBF7wlve7MWAYkBMAAFyMfWGgG0950.jpg?token=544c170e756fad7887c4fa9d21908d01&ts=1541409463\n```\n[代码](http://gitlab.56team.com/56group/fastdfs-quickstart)\n\n[参考](https://www.cnblogs.com/chiangchou/p/fastdfs.html)\n\n##### tracker.conf (调整如下配置项)\n\n```\n# is this config file disabled\n# false for enabled\n# true for disabled\ndisabled=false\n\n# bind an address of this host\n# empty for bind all addresses of this host\nbind_addr=\n\n# the tracker server port\nport=22122\n# the base path to store data and log files\nbase_path=/var/fastdfs/tracker\n\n# HTTP port on this tracker server\nhttp.server_port=80\n```\n##### storage.conf (调整如下配置项)\n\n```\n# is this config file disabled\n# false for enabled\n# true for disabled\ndisabled=false\n\n# the name of the group this storage server belongs to\n#\n# comment or remove this item for fetching from tracker server,\n# in this case, use_storage_id must set to true in tracker.conf,\n# and storage_ids.conf must be configed correctly.\ngroup_name=group1\n\n# the storage server port\nport=23000\n\n# the base path to store data and log files\nbase_path=/var/fastdfs/storage\n\n# store_path#, based 0, if store_path0 not exists, it's value is base_path\n# the paths must be exist\nstore_path0=/var/fastdfs/file\n#store_path1=/home/yuqing/fastdfs2\n\n# tracker_server can ocur more than once, and tracker_server format is\n#  \"host:port\", host can be hostname or ip address\ntracker_server=IP:22122\n\n# the port of the web server on this storage server\nhttp.server_port=80\n```\n##### active\n\n```\n[2018-11-04 20:47:09] DEBUG - base_path=/var/fastdfs/storage, connect_timeout=30, network_timeout=60, tracker_server_count=1, anti_steal_token=0, anti_steal_secret_key length=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s, use_storage_id=0, storage server id count: 0\n\nserver_count=1, server_index=0\n\ntracker server is 172.17.123.194:22122\n\ngroup count: 1\n\nGroup 1:\ngroup name = group1\ndisk total space = 40187 MB\ndisk free space = 36601 MB\ntrunk free space = 0 MB\nstorage server count = 1\nactive server count = 1\nstorage server port = 23000\nstorage HTTP port = 80\nstore path count = 1\nsubdir count per path = 256\ncurrent write server index = 0\ncurrent trunk file id = 0\n\n\tStorage 1:\n\t\tid = 172.17.123.194\n\t\tip_addr = 172.17.123.194 (iZ2ze0ajic0vbsvb8u5lguZ)  ACTIVE # ACTIVE表示通信\n\t\thttp domain = \n\t\tversion = 5.11\n\t\tjoin time = 2018-11-04 20:43:49\n\t\tup time = 2018-11-04 20:43:49\n\t\ttotal storage = 40187 MB\n\t\tfree storage = 36601 MB\n\t\tupload priority = 10\n\t\tstore_path_count = 1\n\t\tsubdir_count_per_path = 256\n\t\tstorage_port = 23000\n\t\tstorage_http_port = 80\n\t\tcurrent_write_path = 0\n\t\tsource storage id = \n\t\tif_trunk_server = 0\n\t\tconnection.alloc_count = 256\n\t\tconnection.current_count = 0\n\t\tconnection.max_count = 0\n\t\ttotal_upload_count = 0\n\t\tsuccess_upload_count = 0\n\t\ttotal_append_count = 0\n\t\tsuccess_append_count = 0\n\t\ttotal_modify_count = 0\n\t\tsuccess_modify_count = 0\n\t\ttotal_truncate_count = 0\n\t\tsuccess_truncate_count = 0\n\t\ttotal_set_meta_count = 0\n\t\tsuccess_set_meta_count = 0\n\t\ttotal_delete_count = 0\n\t\tsuccess_delete_count = 0\n\t\ttotal_download_count = 0\n\t\tsuccess_download_count = 0\n\t\ttotal_get_meta_count = 0\n\t\tsuccess_get_meta_count = 0\n\t\ttotal_create_link_count = 0\n\t\tsuccess_create_link_count = 0\n\t\ttotal_delete_link_count = 0\n\t\tsuccess_delete_link_count = 0\n\t\ttotal_upload_bytes = 0\n\t\tsuccess_upload_bytes = 0\n\t\ttotal_append_bytes = 0\n\t\tsuccess_append_bytes = 0\n\t\ttotal_modify_bytes = 0\n\t\tsuccess_modify_bytes = 0\n\t\tstotal_download_bytes = 0\n\t\tsuccess_download_bytes = 0\n\t\ttotal_sync_in_bytes = 0\n\t\tsuccess_sync_in_bytes = 0\n\t\ttotal_sync_out_bytes = 0\n\t\tsuccess_sync_out_bytes = 0\n\t\ttotal_file_open_count = 0\n\t\tsuccess_file_open_count = 0\n\t\ttotal_file_read_count = 0\n\t\tsuccess_file_read_count = 0\n\t\ttotal_file_write_count = 0\n\t\tsuccess_file_write_count = 0\n\t\tlast_heart_beat_time = 2018-11-04 20:46:53\n\t\tlast_source_update = 1970-01-01 08:00:00\n\t\tlast_sync_update = 1970-01-01 08:00:00\n\t\tlast_synced_timestamp = 1970-01-01 08:00:00\n```\n##### client.conf (调整如下配置项)\n\n```\n# the base path to store log files\nbase_path=/var/fastdfs/client\n\n# tracker_server can ocur more than once, and tracker_server format is\n#  \"host:port\", host can be hostname or ip address\ntracker_server=IP:22122\n```\n##### mod_fdfs.conf\n\n```\n# connect timeout in seconds\n# default value is 30s\nconnect_timeout=10\n\n# FastDFS tracker_server can ocur more than once, and tracker_server format is\n#  \"host:port\", host can be hostname or ip address\n# valid only when load_fdfs_parameters_from_tracker is true\ntracker_server=172.17.123.194:22122\n\n# the port of the local storage server\n# the default value is 23000\nstorage_server_port=23000\n\n# if the url / uri including the group name\n# set to false when uri like /M00/00/00/xxx\n# set to true when uri like ${group_name}/M00/00/00/xxx, such as group1/M00/xxx\n# default value is false\nurl_have_group_name = true # 如果访问路径中有group**需要为true\n\n# store_path#, based 0, if store_path0 not exists, it's value is base_path\n# the paths must be exist\n# must same as storage.conf\nstore_path0=/var/fastdfs/file\n```\n##### nginx.conf\n\n```\n#user  nobody;\nworker_processes  1;\n\n#error_log  logs/error.log;\n#error_log  logs/error.log  notice;\n#error_log  logs/error.log  info;\n\n#pid        logs/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    #access_log  logs/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    server {\n        listen       80;\n        server_name  localhost;\n\n        #charset koi8-r;\n\n        #access_log  logs/host.access.log  main;\n\n        location / {\n            root   html;\n            index  index.html index.htm;\n        }\n       \n        location ~/group([0-9])/M00 {\n            ngx_fastdfs_module;\n        }\n\n        #error_page  404              /404.html;\n\n        # redirect server error pages to the static page /50x.html\n        #\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n}\n\n```",[[1541493583372,["Administrator@DESKTOP-G7HA8HD",[[-1,19,"暗黄"]],[21,21],[19,19]]],[1541493585178,["Administrator@DESKTOP-G7HA8HD",[[1,19,"安装"]],[19,19],[21,21]]]]]]}